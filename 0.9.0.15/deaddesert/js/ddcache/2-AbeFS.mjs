import{isNw}from"../shared/Environment.mjs";let fs=null,app={getPath:()=>""};isNw()&&(fs=await require("fs"));class AbeFS{#fs=null;constructor(a,b,c,d){return this.infoLogger=c||console.log,this.errorLogger=d||console.error,this.#fs=fs,this.folder="",this.readOnly=b,this.ready=!0,this.folderCache={},this.keyCache={},this.ready?void(this.keyFile="keys.json",this.createRoot(a),this.keyTimer=null):void this.errorLogger("[ABE] Broken fs dependency")}addKey(a){this.keyCache[a]||(this.keyCache[a]=!0,this.keyTimer&&clearTimeout(this.keyTimer),this.keyTimer=setTimeout(()=>{this.writeFileSync(this.keyFile,this.keyCache)},1e3))}#getFilename(a){a=this.#stripFileExtension(a)+".json";if(a.substr(-"package.json".length)=="package.json")throw"Cannot write file";return a}#stripFileExtension(a){const b=a.lastIndexOf(".");return-1===b?a:a.slice(0,b)}writeFileSync(a,b,c){c||(c=this.defaultCallback),a=this.#getFilename(a),this.#fs.writeFileSync(this.folder+"/"+a,JSON.stringify(b),c),this.addKey(a),"function"==typeof c&&c()}writeFile(a,b,c){c||(c=this.defaultCallback),a=this.#getFilename(a),this.#fs.writeFile(this.folder+"/"+a,JSON.stringify(b),c),this.addKey(a)}setFolder(a,b){this.folder==this.root+"/"+a||(b&&this.createFolder(a),this.folder=this.root+"/"+a,this.keyCache=this.exists(this.folder+"/"+this.keyFile,!0)?this.readFileSync(this.keyFile):{})}readFileRaw(a,b){b||(b=this.defaultCallback()),a=this.#getFilename(a),this.#fs.readFile(a,"utf8",(a,c)=>a?(this.errorLogger(a),b(!1),!1):void b(JSON.parse(c)))}readFile(a,b){b||(b=this.defaultCallback()),a=this.#getFilename(a),this.#fs.readFile(this.folder+"/"+a,"utf8",(a,c)=>a?(b(!1),!1):void b(JSON.parse(c)))}exists(a,b){return!!this.keyCache[a]||!!b&&this.#fs.existsSync(a)}createRoot(a){return!!this.#fs.existsSync(a)||this.#fs.mkdirSync(this.root)}createFolder(a){return!!this.folderExists(a)||this.#fs.mkdirSync(this.root+"/"+a)}keyExists(a){return!!(this.keyCache[a]||this.keyCache[a+".json"])}folderExists(a){return this.folderCache[a]||(this.folderCache[a]=this.exists(this.root+"/"+a,!0)),this.folderCache[a]}defaultCallback(){}readFileSync(a){return a=this.#getFilename(a),JSON.parse(this.#fs.readFileSync(this.folder+"/"+a,{encoding:"utf8",flag:"r"}))}loadSync(a){return this.readFileSync(a)}save(a,b,c){this.writeFile(a,b,c)}saveSync(a,b,c){this.writeFileSync(a,b,c)}load(a,b){this.readFile(a,b)}getFolder(a){return this.#fs.readdirSync(a)}}window.AbeFs=AbeFS;